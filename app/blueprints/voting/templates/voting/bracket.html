{% extends "base.html" %}

{% block title %}{{ tournament.name }} - Bracket - Auxiliary Analytics{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title">{{ tournament.name }} - Bracket</h1>
        <h2 class="subtitle">{{ tournament.formatted_code }}</h2>

        {% if tournament.description %}
            <div class="content mb-4">
                <p>{{ tournament.description }}</p>
            </div>
        {% endif %}

        <div class="box mb-4">
            <div class="key-value-pair">
                <span class="key">Status:</span>
                <span class="values">
                    <span class="tag {% if tournament.is_voting_phase() %}is-success{% elif tournament.status == 'registration' %}is-warning{% elif tournament.status == 'completed' %}is-light{% else %}is-info{% endif %}">
                        {% if tournament.is_voting_phase() %}
                            Voting Round {{ tournament.get_current_round_number() }}
                        {% else %}
                            {{ tournament.status|capitalize }}
                        {% endif %}
                    </span>
                </span>
            </div>
        </div>

        <div class="tabs is-boxed">
            <ul>
                {% for round_data in rounds_data %}
                <li class="round-tab {% if loop.first %}is-active{% endif %}" data-round="{{ round_data.round.round_number }}">
                    <a>
                        <span>{{ round_data.round.name }}</span>
                        {% if round_data.is_active %}
                            <span class="tag is-success ml-2">Live</span>
                        {% elif round_data.round.status == 'completed' %}
                            <span class="tag is-light ml-2">Completed</span>
                        {% endif %}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        {% for round_data in rounds_data %}
        <div class="round-content {% if not loop.first %}is-hidden{% endif %}" data-round="{{ round_data.round.round_number }}">
            <div class="box">
                <h3 class="title is-4">{{ round_data.round.name }}</h3>

                {% if round_data.round.end_date %}
                    <div class="notification {% if round_data.is_voting_open %}is-info{% else %}is-light{% endif %}">
                        <strong>Deadline:</strong> {{ round_data.round.end_date|strftime('%B %d, %Y at %I:%M %p') }}
                        {% if not round_data.is_voting_open %}
                            <span class="tag is-danger ml-2">Voting Closed</span>
                        {% endif %}
                    </div>
                {% endif %}

                {% if current_user.is_authenticated and tournament.created_by_user_id == current_user.id %}
                    <!-- Tournament Owner Controls -->
                    <div class="box has-background-light mb-4">
                        <h4 class="title is-6">Round Management (Owner Only)</h4>
                        <div class="buttons">
                            {% if round_data.is_active %}
                                <!-- End Round Early -->
                                <form method="POST" action="{{ url_for('tournaments.end_round_early', tournament_id=tournament.id, round_id=round_data.round.id) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="button is-warning" onclick="return confirm('Are you sure you want to end this round early and advance winners?')">
                                        End Round Early
                                    </button>
                                </form>
                            {% endif %}

                            {% if round_data.round.status in ['active', 'pending'] %}
                                <!-- Extend Round -->
                                <div class="field has-addons">
                                    <form method="POST" action="{{ url_for('tournaments.extend_round', tournament_id=tournament.id, round_id=round_data.round.id) }}" style="display: inline-flex;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <div class="control">
                                            <input class="input" type="number" name="extension_hours" value="24" min="1" max="168" style="width: 100px;" placeholder="Hours">
                                        </div>
                                        <div class="control">
                                            <button type="submit" class="button is-info">
                                                Extend Round
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

                {% if round_data.matchups %}
                    <div class="columns is-multiline">
                        {% for matchup in round_data.matchups %}
                        <div class="column is-half">
                            {% if matchup.is_tbd %}
                                <!-- TBD Matchup Card -->
                                <div class="card">
                                    <div class="card-content has-text-centered">
                                        <div class="content">
                                            <p class="title is-5 has-text-grey-light">
                                                {{ matchup.tbd_message }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <!-- Active Matchup Card -->
                                <div class="card matchup-card" data-matchup-id="{{ matchup.id }}">
                                    <div class="card-content">
                                        <!-- Song 1 -->
                                        <div class="song-option mb-3 {% if matchup.user_vote == matchup.song1.id %}selected{% endif %}"
                                             data-song-id="{{ matchup.song1.id }}"
                                             {% if round_data.is_voting_open %}onclick="voteForSong({{ matchup.id }}, {{ matchup.song1.id }})"{% endif %}>
                                            <div class="media">
                                                <div class="media-left">
                                                    {% if matchup.song1.thumbnail_url %}
                                                        <figure class="image is-64x64">
                                                            <img src="{{ matchup.song1.thumbnail_url }}" alt="{{ matchup.song1.title }}">
                                                        </figure>
                                                    {% endif %}
                                                </div>
                                                <div class="media-content">
                                                    <p class="title is-5">{{ matchup.song1.title }}</p>
                                                    <p class="subtitle is-6">{{ matchup.song1.artist }}</p>
                                                    {% if matchup.song1.album %}
                                                        <p class="is-size-7 has-text-grey">{{ matchup.song1.album }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="media-right">
                                                    <span class="tag is-info is-medium">{{ matchup.song1_votes }} votes</span>
                                                </div>
                                            </div>
                                            {% if matchup.song1.spotify_url or matchup.song1.youtube_url %}
                                                <div class="buttons mt-2">
                                                    {% if matchup.song1.spotify_url %}
                                                        <a href="{{ matchup.song1.spotify_url }}" target="_blank" class="button is-small is-success" onclick="event.stopPropagation()">
                                                            Spotify
                                                        </a>
                                                    {% endif %}
                                                    {% if matchup.song1.youtube_url %}
                                                        <a href="{{ matchup.song1.youtube_url }}" target="_blank" class="button is-small is-danger" onclick="event.stopPropagation()">
                                                            YouTube
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <div class="has-text-centered mb-3">
                                            <span class="tag is-medium">VS</span>
                                        </div>

                                        <!-- Song 2 -->
                                        <div class="song-option {% if matchup.user_vote == matchup.song2.id %}selected{% endif %}"
                                             data-song-id="{{ matchup.song2.id }}"
                                             {% if round_data.is_voting_open %}onclick="voteForSong({{ matchup.id }}, {{ matchup.song2.id }})"{% endif %}>
                                            <div class="media">
                                                <div class="media-left">
                                                    {% if matchup.song2.thumbnail_url %}
                                                        <figure class="image is-64x64">
                                                            <img src="{{ matchup.song2.thumbnail_url }}" alt="{{ matchup.song2.title }}">
                                                        </figure>
                                                    {% endif %}
                                                </div>
                                                <div class="media-content">
                                                    <p class="title is-5">{{ matchup.song2.title }}</p>
                                                    <p class="subtitle is-6">{{ matchup.song2.artist }}</p>
                                                    {% if matchup.song2.album %}
                                                        <p class="is-size-7 has-text-grey">{{ matchup.song2.album }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="media-right">
                                                    <span class="tag is-info is-medium">{{ matchup.song2_votes }} votes</span>
                                                </div>
                                            </div>
                                            {% if matchup.song2.spotify_url or matchup.song2.youtube_url %}
                                                <div class="buttons mt-2">
                                                    {% if matchup.song2.spotify_url %}
                                                        <a href="{{ matchup.song2.spotify_url }}" target="_blank" class="button is-small is-success" onclick="event.stopPropagation()">
                                                            Spotify
                                                        </a>
                                                    {% endif %}
                                                    {% if matchup.song2.youtube_url %}
                                                        <a href="{{ matchup.song2.youtube_url }}" target="_blank" class="button is-small is-danger" onclick="event.stopPropagation()">
                                                            YouTube
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>

                                        {% if not round_data.is_voting_open %}
                                            <div class="notification is-light mt-3">
                                                Voting is closed for this round
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="notification is-light">
                        No matchups available for this round yet.
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <div class="buttons mt-4">
            <a href="{{ url_for('tournaments.detail', id=tournament.id) }}" class="button is-link">
                Back to Tournament
            </a>
        </div>
    </div>
</section>

<script>
// Tab switching
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.round-tab');
    const contents = document.querySelectorAll('.round-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const roundNumber = this.dataset.round;

            // Update active tab
            tabs.forEach(t => t.classList.remove('is-active'));
            this.classList.add('is-active');

            // Show corresponding content
            contents.forEach(c => {
                if (c.dataset.round === roundNumber) {
                    c.classList.remove('is-hidden');
                } else {
                    c.classList.add('is-hidden');
                }
            });
        });
    });
});

// Voting functionality
function voteForSong(matchupId, songId) {
    const matchupCard = document.querySelector(`.matchup-card[data-matchup-id="${matchupId}"]`);
    const songOptions = matchupCard.querySelectorAll('.song-option');

    // Send vote to server
    fetch('{{ url_for("voting.vote") }}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: new URLSearchParams({matchup_id: matchupId, song_id: songId}).toString()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI to show selected song
            songOptions.forEach(option => {
                if (parseInt(option.dataset.songId) === songId) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });

            // Show notification
            const notification = document.createElement('div');
            notification.className = 'notification is-success';
            notification.innerHTML = `
                <button class="delete"></button>
                ${data.message}
                ${data.vote_changed ? '<span class="tag is-warning ml-2">Vote Changed</span>' : ''}
            `;

            matchupCard.insertBefore(notification, matchupCard.firstChild);

            // Add delete functionality
            const deleteBtn = notification.querySelector('.delete');
            deleteBtn.addEventListener('click', () => notification.remove());

            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);

            // Reload page to update vote counts
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            // Show error
            alert(data.error || 'Failed to submit vote');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to submit vote. Please try again.');
    });
}
</script>

<style>
.song-option {
    padding: 1rem;
    border: 2px solid #dbdbdb;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.song-option:hover {
    border-color: #3273dc;
    background-color: #f5f5f5;
}

.song-option.selected {
    border-color: #48c774;
    background-color: #effaf3;
}

.matchup-card {
    height: 100%;
}

.key-value-pair {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.key-value-pair .key {
    font-weight: 600;
    min-width: 150px;
}

.key-value-pair .values {
    flex: 1;
}
</style>
{% endblock %}
